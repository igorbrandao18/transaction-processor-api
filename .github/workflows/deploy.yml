name: Deploy to Production

on:
  push:
    branches:
      - main

env:
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
  DB_NAME: ${{ secrets.DB_NAME }}
  DB_USER: ${{ secrets.DB_USER }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  DOMAIN: ${{ secrets.DOMAIN }}

jobs:
  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        env:
          NODE_ENV: test
        run: npm run test:unit

  setup:
    name: ๐ Setup and Verify SSH Connection
    runs-on: ubuntu-latest
    needs: test-unit
    
    steps:
      - name: ๐พ Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: apt-${{ runner.os }}-sshpass
          restore-keys: |
            apt-${{ runner.os }}-

      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends sshpass
          echo "โ sshpass installed successfully"
          sshpass -V || true
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ Test SSH connection
        run: |
          echo "::add-mask::$SSH_PASSWORD"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Testing SSH connection to deployment server..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Connection details:"
          echo "   Host: $SSH_HOST"
          echo "   User: $SSH_USER"
          echo "   Method: Password authentication"
          echo ""
          echo "๐จ Attempting SSH connection..."
          if sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout=10 \
            $SSH_USER@$SSH_HOST "echo 'โ SSH connection successful' && hostname && uname -a"; then
            echo ""
            echo "โ SUCCESS: SSH connection established successfully!"
          else
            echo ""
            echo "โ ERROR: Failed to establish SSH connection"
            exit 1
          fi
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

  backup:
    name: ๐พ Backup Database
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: ๐พ Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: apt-${{ runner.os }}-sshpass
          restore-keys: |
            apt-${{ runner.os }}-

      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends sshpass
          echo "โ sshpass installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐พ Create and cleanup database backup
        run: |
          echo "::add-mask::$SSH_PASSWORD"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐พ Creating database backup and cleaning up old backups..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST "DB_NAME='$DB_NAME' DB_USER='$DB_USER' bash -s" << 'ENDSSH'
            echo "๐ Checking PostgreSQL container..."
            if docker ps --format '{{.Names}}' | grep -q 'transaction-db'; then
              echo "โ PostgreSQL container is running"
              
              BACKUP_DIR="/tmp/backups"
              mkdir -p "$BACKUP_DIR"
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              BACKUP_FILE="$BACKUP_DIR/${DB_NAME}_${TIMESTAMP}.sql"
              
              echo "๐พ Creating backup: $BACKUP_FILE"
              docker exec transaction-db pg_dump -U "$DB_USER" -d "$DB_NAME" > "$BACKUP_FILE" 2>&1 || echo "โ๏ธ Backup may have failed (OK for first deployment)"
              
              if [ -f "$BACKUP_FILE" ] && [ -s "$BACKUP_FILE" ]; then
                BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
                echo "โ Backup created: $BACKUP_SIZE"
              fi
              
              echo "๐งน Cleaning up old backups (keeping last 5)..."
              BACKUP_COUNT=$(ls -1 "$BACKUP_DIR/${DB_NAME}"_*.sql 2>/dev/null | wc -l)
              if [ "$BACKUP_COUNT" -gt 5 ]; then
                cd "$BACKUP_DIR"
                ls -t "${DB_NAME}"_*.sql 2>/dev/null | tail -n +6 | xargs rm -f || true
                echo "โ Old backups removed"
              fi
            else
              echo "โน๏ธ PostgreSQL container not running (OK for first deployment)"
            fi
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH

  prepare-deployment:
    name: ๐ฆ Prepare Deployment
    runs-on: ubuntu-latest
    needs: backup
    
    steps:
      - name: ๐พ Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: apt-${{ runner.os }}-sshpass
          restore-keys: |
            apt-${{ runner.os }}-

      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends sshpass
          echo "โ sshpass installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ฅ Clone repository and prepare archive
        env:
          REPO_URL: https://github.com/${{ github.repository }}.git
        run: |
          echo "::add-mask::$SSH_PASSWORD"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฆ Preparing deployment (clone + archive)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST << ENDSSH
            echo "๐ฅ Cloning repository..."
            mkdir -p /tmp
            cd /tmp
            rm -rf transaction-processor-api
            git clone $REPO_URL transaction-processor-api
            cd transaction-processor-api
            
            echo "๐ฆ Creating application archive..."
            tar -czf app.tar.gz \
              --exclude='node_modules' --exclude='dist' --exclude='build' \
              --exclude='test' --exclude='coverage' --exclude='*.spec.ts' \
              --exclude='.git' --exclude='docker' --exclude='*.md' \
              src/ package*.json tsconfig*.json nest-cli.json prisma/ \
              eslint.config.mjs .prettierrc prisma.config.ts 2>&1
            
            echo "โ Archive created: $(du -h app.tar.gz | cut -f1)"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH

  build-and-deploy:
    name: ๐ Build and Deploy
    runs-on: ubuntu-latest
    needs: prepare-deployment
    
    steps:
      - name: ๐พ Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: apt-${{ runner.os }}-sshpass
          restore-keys: |
            apt-${{ runner.os }}-

      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends sshpass
          echo "โ sshpass installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ Stop, build and start containers
        run: |
          echo "::add-mask::$SSH_PASSWORD"
          echo "::add-mask::$DB_PASSWORD"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Building and deploying containers..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST "DB_NAME='$DB_NAME' DB_USER='$DB_USER' DB_PASSWORD='$DB_PASSWORD' bash -s" << 'ENDSSH'
            cd /tmp/transaction-processor-api/docker
            
            echo "๐ Stopping existing API containers only..."
            echo "โ๏ธ  IMPORTANT: This will only affect API containers defined in docker-compose.yml"
            echo "โ๏ธ  Containers: transaction-api, transaction-db, transaction-redis, transaction-pgadmin"
            echo "โ๏ธ  Frontend and other containers will remain untouched"
            echo "โ๏ธ  Database volumes will be preserved (no data loss)"
            
            # Stop only containers defined in this docker-compose.yml (API containers)
            # docker compose down only affects containers in the current docker-compose.yml file
            # IMPORTANT: Do NOT use -v flag to preserve database volumes
            docker compose down || true
            
            echo "โ Cleanup completed - only API containers from docker-compose.yml were affected"
            echo "โ Database volumes preserved (production data safe)"
            
            echo "๐จ Building containers with cache optimization..."
            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1
            echo "๐ฅ Pulling base images (using cache)..."
            docker compose pull || true
            echo "๐จ Building containers (reusing cached layers)..."
            docker compose build --pull --progress=plain
            
            echo "๐ Starting containers..."
            docker compose up -d
            
            echo "โณ Waiting for services to initialize..."
            sleep 15
            
            # Copy Prisma files to container after it starts
            echo "๐ฆ Copying Prisma files to container..."
            if [ -d "/tmp/transaction-processor-api/prisma" ]; then
              docker cp /tmp/transaction-processor-api/prisma transaction-api:/app/prisma || echo "โ๏ธ Could not copy prisma directory"
              docker cp /tmp/transaction-processor-api/prisma.config.ts transaction-api:/app/prisma.config.ts || echo "โ๏ธ Could not copy prisma.config.ts"
            else
              echo "โ๏ธ Prisma directory not found at /tmp/transaction-processor-api/prisma"
            fi
            
            cd /tmp/transaction-processor-api
            rm -f app.tar.gz || true
            
            echo "๐ Container status:"
            docker compose ps
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH

  wait-services:
    name: โณ Wait Services and Restore Backup
    runs-on: ubuntu-latest
    needs: build-and-deploy
    
    steps:
      - name: ๐พ Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: apt-${{ runner.os }}-sshpass
          restore-keys: |
            apt-${{ runner.os }}-

      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends sshpass
          echo "โ sshpass installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: โณ Wait for services and restore backup
        run: |
          echo "::add-mask::$SSH_PASSWORD"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โณ Waiting for services and restoring backup..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST "DB_NAME='$DB_NAME' DB_USER='$DB_USER' bash -s" << 'ENDSSH'
            echo "โณ Waiting for PostgreSQL..."
            timeout=60
            elapsed=0
            while [ $elapsed -lt $timeout ]; do
              if docker exec transaction-db pg_isready -U "$DB_USER" > /dev/null 2>&1; then
                echo "โ PostgreSQL is ready"
                break
              fi
              sleep 2
              elapsed=$((elapsed + 2))
            done
            
            echo "๐ Checking if production database already exists..."
            DB_EXISTS=$(docker exec transaction-db psql -U "$DB_USER" -lqt 2>/dev/null | cut -d \| -f 1 | grep -qw "$DB_NAME" && echo "yes" || echo "no")
            
            if [ "$DB_EXISTS" = "yes" ]; then
              echo "โ Production database '$DB_NAME' already exists - preserving existing data"
              echo "๐ Database will use existing data from volume (no data loss)"
              echo "๐พ Backup is available for manual rollback if needed"
            else
              echo "๐ฅ Production database '$DB_NAME' does not exist - creating new database..."
              echo "โ๏ธ  This is likely the first deployment"
              docker exec -i transaction-db psql -U "$DB_USER" -d postgres -c "CREATE DATABASE $DB_NAME;" || echo "โ๏ธ Database may already exist"
              echo "โ Production database created"
              echo "๐พ Backup will be created after migrations for future rollback"
            fi
            
            echo "โณ Waiting for application..."
            elapsed=0
            while [ $elapsed -lt $timeout ]; do
              if docker ps --format '{{.Names}}' | grep -q 'transaction-api' && \
                 docker exec transaction-api node -e "console.log('OK')" > /dev/null 2>&1; then
                echo "โ Application is ready"
                break
              fi
              sleep 2
              elapsed=$((elapsed + 2))
            done
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH

  finalize-deployment:
    name: ๐ Finalize Deployment
    runs-on: ubuntu-latest
    needs: wait-services
    
    steps:
      - name: ๐พ Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: apt-${{ runner.os }}-sshpass
          restore-keys: |
            apt-${{ runner.os }}-

      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends sshpass
          echo "โ sshpass installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ Run migrations and verify status
        run: |
          echo "::add-mask::$SSH_PASSWORD"
          echo "::add-mask::$DB_PASSWORD"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Finalizing deployment (migrations + verification)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST "DB_NAME='$DB_NAME' DB_USER='$DB_USER' DB_PASSWORD='$DB_PASSWORD' DATABASE_URL='postgresql://$DB_USER:$DB_PASSWORD@transaction-db:5432/$DB_NAME?schema=public' bash -s" << 'ENDSSH'
            echo "๐ Running Prisma migrations..."
            echo "๐ Migration details:"
            echo "   Database: $DB_NAME"
            echo "   User: $DB_USER"
            echo "   Host: transaction-db:5432"
            echo ""
            
            # Check if Prisma schema exists
            if [ -f "/tmp/transaction-processor-api/prisma/schema.prisma" ]; then
              echo "โ Prisma schema found"
            else
              echo "โ ERROR: Prisma schema not found at /tmp/transaction-processor-api/prisma/schema.prisma"
              echo "๐ Checking available files..."
              ls -la /tmp/transaction-processor-api/ | head -20
              exit 1
            fi
            
            # Check if migrations directory exists
            if [ -d "/tmp/transaction-processor-api/prisma/migrations" ]; then
              echo "โ Migrations directory found"
              MIGRATION_COUNT=$(find /tmp/transaction-processor-api/prisma/migrations -mindepth 1 -maxdepth 1 -type d | wc -l)
              echo "   Found $MIGRATION_COUNT migration(s)"
            else
              echo "โ๏ธ  WARNING: Migrations directory not found"
            fi
            
            # Check if container is running
            echo "๐ Checking if transaction-api container is running..."
            cd /tmp/transaction-processor-api/docker
            if ! docker ps --format '{{.Names}}' | grep -q '^transaction-api$'; then
              echo "โ ERROR: transaction-api container is not running"
              echo "๐ Checking container status..."
              docker ps -a | grep transaction-api || echo "Container not found"
              echo "๐ Checking docker compose status..."
              docker compose ps
              echo "๐ Attempting to start container..."
              # Try to start the app service (which creates transaction-api container)
              docker compose up -d app || {
                echo "โ Failed to start app service"
                echo "๐ Checking if container exists but stopped..."
                if docker ps -a --format '{{.Names}}' | grep -q '^transaction-api$'; then
                  echo "๐ Container exists but stopped, trying to start it directly..."
                  docker start transaction-api || {
                    echo "โ Failed to start container directly"
                    echo "๐ Checking logs..."
                    docker logs transaction-api --tail 50 || true
                    echo "๐ Checking docker compose logs..."
                    docker compose logs app --tail 50 || true
                    exit 1
                  }
                else
                  echo "โ Container does not exist"
                  echo "๐ Checking docker compose logs..."
                  docker compose logs app --tail 50 || true
                  exit 1
                fi
              }
              echo "โณ Waiting for container to be ready..."
              sleep 15
              # Verify container is now running
              if ! docker ps --format '{{.Names}}' | grep -q '^transaction-api$'; then
                echo "โ Container still not running after start attempt"
                docker ps -a | grep transaction-api || echo "Container not found"
                docker logs transaction-api --tail 50 || true
                exit 1
              fi
              echo "โ Container started successfully"
            else
              echo "โ transaction-api container is running"
            fi
            
            # Copy Prisma files to container if needed
            echo "๐ฆ Copying Prisma files to container..."
            docker cp /tmp/transaction-processor-api/prisma transaction-api:/app/prisma || {
              echo "โ๏ธ  Could not copy prisma directory, checking if it already exists..."
              docker exec transaction-api ls -la /app/prisma 2>&1 || echo "Prisma directory does not exist in container"
            }
            
            # Verify container is still running before migrations
            if ! docker ps --format '{{.Names}}' | grep -q '^transaction-api$'; then
              echo "โ ERROR: Container stopped before migrations"
              docker logs transaction-api --tail 50 || true
              exit 1
            fi
            
            # Run migrations
            echo "๐ Executing Prisma migrations..."
            docker exec transaction-api sh -c "cd /app && DATABASE_URL='$DATABASE_URL' npx prisma migrate deploy" || {
              echo "โ๏ธ  Migration command failed, checking logs..."
              docker logs transaction-api --tail 50 | grep -i "migration\|prisma\|error" || true
              echo "โ๏ธ  Checking container status..."
              docker ps | grep transaction-api || echo "Container is not running"
              echo "โ๏ธ  Attempting alternative migration method..."
              docker exec transaction-api sh -c "cd /app && DATABASE_URL='$DATABASE_URL' npm run migrate" || {
                echo "โ ERROR: All migration attempts failed"
                echo "๐ Checking Prisma installation..."
                docker exec transaction-api sh -c "cd /app && npx prisma --version" || echo "Prisma not found"
                echo "๐ Container logs:"
                docker logs transaction-api --tail 100 || true
                exit 1
              }
            }
            
            echo "โ Migrations completed successfully"
            
            echo "๐ Deployment status:"
            cd /tmp/transaction-processor-api/docker
            docker compose ps
            echo ""
            echo "๐ Application logs (last 20 lines):"
            docker compose logs --tail=20 transaction-api || true
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH

  verify:
    name: โ Verify Deployment
    runs-on: ubuntu-latest
    needs: finalize-deployment
    
    steps:
      - name: ๐ Verify HTTP redirects to HTTPS
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Verifying HTTP redirects to HTTPS..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Test configuration:"
          echo "   Domain: $DOMAIN"
          echo "   Endpoint: /health"
          echo "   Expected: HTTP redirect (301 or 302) to HTTPS"
          echo ""
          echo "๐จ Testing HTTP endpoint..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$DOMAIN/health || echo "000")
          echo "   HTTP Status Code: $HTTP_STATUS"
          echo ""
          
          if [ "$HTTP_STATUS" = "301" ] || [ "$HTTP_STATUS" = "302" ]; then
            echo "โ SUCCESS: HTTP correctly redirects to HTTPS"
          else
            echo "โ๏ธ  WARNING: HTTP returned status $HTTP_STATUS (expected 301 or 302)"
            echo "   This may indicate Nginx is not configured for HTTPS redirect"
          fi
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ Verify HTTPS endpoint
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Verifying HTTPS endpoint..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Test configuration:"
          echo "   Domain: $DOMAIN"
          echo "   Endpoint: /health"
          echo "   Protocol: HTTPS"
          echo "   Expected: HTTP 200 OK"
          echo ""
          echo "๐จ Testing HTTPS endpoint..."
          HTTPS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://$DOMAIN/health || echo "000")
          RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" https://$DOMAIN/health || echo "0")
          echo "   HTTPS Status Code: $HTTPS_STATUS"
          echo "   Response Time: ${RESPONSE_TIME}s"
          echo ""
          
          if [ "$HTTPS_STATUS" = "200" ]; then
            echo "โ SUCCESS: Deployment successful! HTTPS is working."
          else
            echo "โ ERROR: HTTPS endpoint returned status $HTTPS_STATUS (expected 200)"
            echo "   Deployment verification failed"
            exit 1
          fi
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: โ Verify health endpoint response
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ Verifying health endpoint response..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Test configuration:"
          echo "   Endpoint: https://$DOMAIN/health"
          echo "   Expected: JSON response with status: UP"
          echo ""
          echo "๐จ Fetching health endpoint response..."
          RESPONSE=$(curl -s https://$DOMAIN/health)
          echo "   Response: $RESPONSE"
          echo ""
          
          if echo "$RESPONSE" | grep -q '"status":"UP"'; then
            echo "โ SUCCESS: Health endpoint is responding correctly"
            echo "   Application status: UP"
          else
            echo "โ๏ธ  WARNING: Health endpoint response may be incorrect"
            echo "   Response does not contain expected status: UP"
          fi
          echo ""
          echo "๐ Parsed health check details:"
          echo "$RESPONSE" | grep -o '"status":"[^"]*"' || echo "   Unable to parse status"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Deployment verification completed successfully!"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
