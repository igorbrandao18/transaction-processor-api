apiVersion: 1

groups:
  - name: application_alerts
    folder: Application
    interval: 10s
    rules:
      - uid: high_error_rate
        title: High Error Rate
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: |
                sum(rate(http_requests_total{status_code=~"5.."}[5m])) / 
                sum(rate(http_requests_total[5m])) * 100 > 5
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: Error rate is above 5% for more than 5 minutes
          summary: High error rate detected

      - uid: high_latency
        title: High Latency (p95 > 1s)
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: |
                histogram_quantile(0.95, 
                  sum(rate(http_request_duration_seconds_bucket[5m])) by (le, route)
                ) > 1
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: p95 latency is above 1 second for more than 5 minutes
          summary: High latency detected

      - uid: application_down
        title: Application Down
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: up{job="transaction-api"} == 0
              refId: A
        noDataState: Alerting
        execErrState: Alerting
        for: 1m
        annotations:
          description: Application is not responding
          summary: Application is down

  - name: container_alerts
    folder: Infrastructure
    interval: 10s
    rules:
      - uid: high_cpu_usage
        title: High CPU Usage (>80%)
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: |
                rate(container_cpu_usage_seconds_total{name=~"transaction-.*"}[5m]) * 100 > 80
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: CPU usage is above 80% for more than 5 minutes
          summary: High CPU usage detected

      - uid: high_memory_usage
        title: High Memory Usage (>80%)
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: PBFA97CFB590B2093
            model:
              expr: |
                (container_memory_usage_bytes{name=~"transaction-.*"} / 
                 container_spec_memory_limit_bytes{name=~"transaction-.*"}) * 100 > 80
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: Memory usage is above 80% for more than 5 minutes
          summary: High memory usage detected

