name: Deploy to Production

on:
  push:
    branches:
      - main

env:
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
  DB_NAME: ${{ secrets.DB_NAME }}
  DB_USER: ${{ secrets.DB_USER }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  DOMAIN: ${{ secrets.DOMAIN }}
  TEST_DB_NAME: ${{ secrets.TEST_DB_NAME }}
  TEST_DB_USER: ${{ secrets.TEST_DB_USER }}
  TEST_DB_PASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
  TEST_DB_HOST: ${{ secrets.TEST_DB_HOST }}
  TEST_DB_PORT: ${{ secrets.TEST_DB_PORT }}
  TEST_REDIS_HOST: ${{ secrets.TEST_REDIS_HOST }}
  TEST_REDIS_PORT: ${{ secrets.TEST_REDIS_PORT }}
  TEST_POSTGRES_DB: ${{ secrets.TEST_POSTGRES_DB }}

jobs:
  lint:
    name: Lint Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint:check

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        env:
          NODE_ENV: test
        run: npm run test:unit

  setup-test-database:
    name: ğŸ“¦ Setup Test Database
    runs-on: ubuntu-latest
    needs: test-unit
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: ${{ secrets.TEST_DB_USER }}
          POSTGRES_PASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          POSTGRES_DB: ${{ secrets.TEST_POSTGRES_DB }}
        ports:
          - ${{ secrets.TEST_DB_PORT }}:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: ğŸ’¾ Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: apt-${{ runner.os }}-postgresql-client
          restore-keys: |
            apt-${{ runner.os }}-

      - name: ğŸ“¥ Install PostgreSQL client tools
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¥ Installing PostgreSQL client tools..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends postgresql-client
          echo "âœ… PostgreSQL client installed"
          psql --version

      - name: ğŸ” Check PostgreSQL service availability
        env:
          PGHOST: ${{ secrets.TEST_DB_HOST }}
          PGPORT: ${{ secrets.TEST_DB_PORT }}
          PGUSER: ${{ secrets.TEST_DB_USER }}
          PGPASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Checking PostgreSQL service availability..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“ Connection details:"
          echo "   Host: ${{ secrets.TEST_DB_HOST }}"
          echo "   Port: ${{ secrets.TEST_DB_PORT }}"
          echo "   User: ${{ secrets.TEST_DB_USER }}"
          echo "   Database: ${{ secrets.TEST_POSTGRES_DB }} (default - service container)"
          echo ""
          echo "â³ Waiting for PostgreSQL to accept connections..."
          MAX_RETRIES=30
          RETRY_COUNT=0
          until pg_isready -h ${{ secrets.TEST_DB_HOST }} -p ${{ secrets.TEST_DB_PORT }} -U ${{ secrets.TEST_DB_USER }}; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
              echo "âŒ PostgreSQL service did not become ready after $MAX_RETRIES attempts"
              exit 1
            fi
            echo "   Attempt $RETRY_COUNT/$MAX_RETRIES: PostgreSQL not ready yet, waiting 2 seconds..."
            sleep 2
          done
          echo "âœ… PostgreSQL service is ready and accepting connections"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ“Š List existing databases
        env:
          PGHOST: ${{ secrets.TEST_DB_HOST }}
          PGPORT: ${{ secrets.TEST_DB_PORT }}
          PGUSER: ${{ secrets.TEST_DB_USER }}
          PGPASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Current databases before test database creation:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          psql -h ${{ secrets.TEST_DB_HOST }} -p ${{ secrets.TEST_DB_PORT }} -U ${{ secrets.TEST_DB_USER }} -c "\l" || true
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ†• Create test database
        env:
          PGHOST: ${{ secrets.TEST_DB_HOST }}
          PGPORT: ${{ secrets.TEST_DB_PORT }}
          PGUSER: ${{ secrets.TEST_DB_USER }}
          PGPASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          TEST_DB_NAME: ${{ secrets.TEST_DB_NAME }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ†• Creating test database..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Database details:"
          echo "   Name: $TEST_DB_NAME"
          echo "   Owner: ${{ secrets.TEST_DB_USER }}"
          echo "   Encoding: UTF8 (default)"
          echo "   Purpose: Integration tests execution"
          echo ""
          echo "ğŸ”¨ Executing CREATE DATABASE command..."
          if psql -h ${{ secrets.TEST_DB_HOST }} -p ${{ secrets.TEST_DB_PORT }} -U ${{ secrets.TEST_DB_USER }} -c "CREATE DATABASE $TEST_DB_NAME;" 2>&1; then
            echo ""
            echo "âœ… SUCCESS: Test database '$TEST_DB_NAME' created successfully!"
          else
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 0 ]; then
              echo ""
              echo "âš ï¸  WARNING: Database '$TEST_DB_NAME' may already exist (this is OK)"
            else
              echo ""
              echo "âŒ ERROR: Failed to create test database"
              exit $EXIT_CODE
            fi
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: âœ… Verify test database creation
        env:
          PGHOST: ${{ secrets.TEST_DB_HOST }}
          PGPORT: ${{ secrets.TEST_DB_PORT }}
          PGUSER: ${{ secrets.TEST_DB_USER }}
          PGPASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          TEST_DB_NAME: ${{ secrets.TEST_DB_NAME }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Verifying test database exists..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if psql -h ${{ secrets.TEST_DB_HOST }} -p ${{ secrets.TEST_DB_PORT }} -U ${{ secrets.TEST_DB_USER }} -lqt | cut -d \| -f 1 | grep -qw "$TEST_DB_NAME"; then
            echo "âœ… VERIFIED: Test database '$TEST_DB_NAME' exists"
            echo ""
            echo "ğŸ“Š Database information:"
            psql -h ${{ secrets.TEST_DB_HOST }} -p ${{ secrets.TEST_DB_PORT }} -U ${{ secrets.TEST_DB_USER }} -c "\l" | grep -E "Name|$TEST_DB_NAME" || true
          else
            echo "âŒ ERROR: Test database '$TEST_DB_NAME' was not created!"
            exit 1
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Test database setup completed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: setup-test-database
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: ${{ secrets.TEST_DB_USER }}
          POSTGRES_PASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          POSTGRES_DB: ${{ secrets.TEST_POSTGRES_DB }}
        ports:
          - ${{ secrets.TEST_DB_PORT }}:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - ${{ secrets.TEST_REDIS_PORT }}:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: ğŸ’¾ Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: apt-${{ runner.os }}-postgresql-client
          restore-keys: |
            apt-${{ runner.os }}-

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends postgresql-client

      - name: Wait for PostgreSQL service
        env:
          PGHOST: ${{ secrets.TEST_DB_HOST }}
          PGPORT: ${{ secrets.TEST_DB_PORT }}
          PGUSER: ${{ secrets.TEST_DB_USER }}
          PGPASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
        run: |
          echo "ğŸ” Checking PostgreSQL service availability..."
          until pg_isready -h ${{ secrets.TEST_DB_HOST }} -p ${{ secrets.TEST_DB_PORT }} -U ${{ secrets.TEST_DB_USER }}; do
            echo "â³ Waiting for PostgreSQL to be ready..."
            sleep 2
          done
          echo "âœ… PostgreSQL service is ready"

      - name: Create test database if not exists
        env:
          PGHOST: ${{ secrets.TEST_DB_HOST }}
          PGPORT: ${{ secrets.TEST_DB_PORT }}
          PGUSER: ${{ secrets.TEST_DB_USER }}
          PGPASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          TEST_DB_NAME: ${{ secrets.TEST_DB_NAME }}
        run: |
          echo "ğŸ” Checking if test database exists..."
          if psql -h ${{ secrets.TEST_DB_HOST }} -p ${{ secrets.TEST_DB_PORT }} -U ${{ secrets.TEST_DB_USER }} -lqt | cut -d \| -f 1 | grep -qw "$TEST_DB_NAME"; then
            echo "âœ… Test database '$TEST_DB_NAME' already exists"
          else
            echo "ğŸ“¦ Creating test database '$TEST_DB_NAME'..."
            psql -h ${{ secrets.TEST_DB_HOST }} -p ${{ secrets.TEST_DB_PORT }} -U ${{ secrets.TEST_DB_USER }} -c "CREATE DATABASE $TEST_DB_NAME;" || echo "âš ï¸ Database may already exist"
            echo "âœ… Test database '$TEST_DB_NAME' created"
          fi

      - name: Run database migrations
        env:
          NODE_ENV: test
          DB_HOST: ${{ secrets.TEST_DB_HOST }}
          DB_PORT: ${{ secrets.TEST_DB_PORT }}
          DB_USER: ${{ secrets.TEST_DB_USER }}
          DB_PASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          DB_NAME: ${{ secrets.TEST_DB_NAME }}
        run: |
          echo "ğŸ”„ Running database migrations on test database..."
          npm run migrate
          echo "âœ… Migrations completed"

      - name: Run integration tests
        env:
          NODE_ENV: test
          DB_HOST: ${{ secrets.TEST_DB_HOST }}
          DB_PORT: ${{ secrets.TEST_DB_PORT }}
          DB_USER: ${{ secrets.TEST_DB_USER }}
          DB_PASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          DB_NAME: ${{ secrets.TEST_DB_NAME }}
          REDIS_HOST: ${{ secrets.TEST_REDIS_HOST }}
          REDIS_PORT: ${{ secrets.TEST_REDIS_PORT }}
        run: |
          echo "ğŸ§ª Running integration tests against test database..."
          npm run test:integration

  cleanup-test-database:
    name: ğŸ—‘ï¸  Cleanup Test Database
    runs-on: ubuntu-latest
    needs: [setup-test-database, test-integration]
    if: always()
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: ${{ secrets.TEST_DB_USER }}
          POSTGRES_PASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          POSTGRES_DB: ${{ secrets.TEST_POSTGRES_DB }}
        ports:
          - ${{ secrets.TEST_DB_PORT }}:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: ğŸ’¾ Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: apt-${{ runner.os }}-postgresql-client
          restore-keys: |
            apt-${{ runner.os }}-

      - name: ğŸ“¥ Install PostgreSQL client tools
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¥ Installing PostgreSQL client tools for cleanup..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends postgresql-client
          echo "âœ… PostgreSQL client installed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ” Check PostgreSQL service availability
        env:
          PGHOST: ${{ secrets.TEST_DB_HOST }}
          PGPORT: ${{ secrets.TEST_DB_PORT }}
          PGUSER: ${{ secrets.TEST_DB_USER }}
          PGPASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Checking PostgreSQL service availability..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          MAX_RETRIES=30
          RETRY_COUNT=0
          until pg_isready -h ${{ secrets.TEST_DB_HOST }} -p ${{ secrets.TEST_DB_PORT }} -U ${{ secrets.TEST_DB_USER }}; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
              echo "âŒ PostgreSQL service did not become ready"
              exit 1
            fi
            echo "   Attempt $RETRY_COUNT/$MAX_RETRIES: Waiting for PostgreSQL..."
            sleep 2
          done
          echo "âœ… PostgreSQL service is ready"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ“Š List databases before cleanup
        env:
          PGHOST: ${{ secrets.TEST_DB_HOST }}
          PGPORT: ${{ secrets.TEST_DB_PORT }}
          PGUSER: ${{ secrets.TEST_DB_USER }}
          PGPASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          TEST_DB_NAME: ${{ secrets.TEST_DB_NAME }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Current databases before cleanup:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          psql -h ${{ secrets.TEST_DB_HOST }} -p ${{ secrets.TEST_DB_PORT }} -U ${{ secrets.TEST_DB_USER }} -c "\l" || true
          echo ""
          if psql -h ${{ secrets.TEST_DB_HOST }} -p ${{ secrets.TEST_DB_PORT }} -U ${{ secrets.TEST_DB_USER }} -lqt | cut -d \| -f 1 | grep -qw "$TEST_DB_NAME"; then
            echo "âœ… Test database '$TEST_DB_NAME' found - will be removed"
          else
            echo "âš ï¸  Test database '$TEST_DB_NAME' not found - may have been already removed"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ—‘ï¸  Drop test database
        env:
          PGHOST: ${{ secrets.TEST_DB_HOST }}
          PGPORT: ${{ secrets.TEST_DB_PORT }}
          PGUSER: ${{ secrets.TEST_DB_USER }}
          PGPASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          TEST_DB_NAME: ${{ secrets.TEST_DB_NAME }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ—‘ï¸  Cleaning up test database..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Cleanup details:"
          echo "   Database to remove: $TEST_DB_NAME"
          echo "   Command: DROP DATABASE IF EXISTS $TEST_DB_NAME"
          echo "   Purpose: Free up resources after test execution"
          echo ""
          echo "ğŸ”¨ Executing DROP DATABASE command..."
          if psql -h ${{ secrets.TEST_DB_HOST }} -p ${{ secrets.TEST_DB_PORT }} -U ${{ secrets.TEST_DB_USER }} -c "DROP DATABASE IF EXISTS $TEST_DB_NAME;" 2>&1; then
            echo ""
            echo "âœ… SUCCESS: Test database '$TEST_DB_NAME' destroyed successfully!"
          else
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 0 ]; then
              echo ""
              echo "âš ï¸  WARNING: Database '$TEST_DB_NAME' may not exist (this is OK)"
            else
              echo ""
              echo "âŒ ERROR: Failed to drop test database (exit code: $EXIT_CODE)"
              echo "âš ï¸  Continuing cleanup process..."
            fi
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: âœ… Verify test database removal
        env:
          PGHOST: ${{ secrets.TEST_DB_HOST }}
          PGPORT: ${{ secrets.TEST_DB_PORT }}
          PGUSER: ${{ secrets.TEST_DB_USER }}
          PGPASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
          TEST_DB_NAME: ${{ secrets.TEST_DB_NAME }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Verifying test database has been removed..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if psql -h ${{ secrets.TEST_DB_HOST }} -p ${{ secrets.TEST_DB_PORT }} -U ${{ secrets.TEST_DB_USER }} -lqt | cut -d \| -f 1 | grep -qw "$TEST_DB_NAME"; then
            echo "âš ï¸  WARNING: Test database '$TEST_DB_NAME' still exists"
            echo "ğŸ“Š Current database list:"
            psql -h ${{ secrets.TEST_DB_HOST }} -p ${{ secrets.TEST_DB_PORT }} -U ${{ secrets.TEST_DB_USER }} -c "\l" || true
          else
            echo "âœ… VERIFIED: Test database '$TEST_DB_NAME' has been successfully removed"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ“Š Show remaining databases
        env:
          PGHOST: ${{ secrets.TEST_DB_HOST }}
          PGPORT: ${{ secrets.TEST_DB_PORT }}
          PGUSER: ${{ secrets.TEST_DB_USER }}
          PGPASSWORD: ${{ secrets.TEST_DB_PASSWORD }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š Remaining databases after cleanup:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          psql -h ${{ secrets.TEST_DB_HOST }} -p ${{ secrets.TEST_DB_PORT }} -U ${{ secrets.TEST_DB_USER }} -c "\l" || true
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Test database cleanup completed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  setup:
    name: ğŸ”Œ Setup and Verify SSH Connection
    runs-on: ubuntu-latest
    needs: cleanup-test-database
    
    steps:
      - name: ğŸ’¾ Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: apt-${{ runner.os }}-sshpass
          restore-keys: |
            apt-${{ runner.os }}-

      - name: ğŸ“¥ Install SSH tools
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¥ Installing SSH tools (sshpass)..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends sshpass
          echo "âœ… sshpass installed successfully"
          sshpass -V || true
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ” Test SSH connection
        run: |
          echo "::add-mask::$SSH_PASSWORD"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Testing SSH connection to deployment server..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Connection details:"
          echo "   Host: $SSH_HOST"
          echo "   User: $SSH_USER"
          echo "   Method: Password authentication"
          echo ""
          echo "ğŸ”¨ Attempting SSH connection..."
          if sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout=10 \
            $SSH_USER@$SSH_HOST "echo 'âœ… SSH connection successful' && hostname && uname -a"; then
            echo ""
            echo "âœ… SUCCESS: SSH connection established successfully!"
          else
            echo ""
            echo "âŒ ERROR: Failed to establish SSH connection"
            exit 1
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  backup:
    name: ğŸ’¾ Backup Database
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: ğŸ’¾ Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: apt-${{ runner.os }}-sshpass
          restore-keys: |
            apt-${{ runner.os }}-

      - name: ğŸ“¥ Install SSH tools
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¥ Installing SSH tools (sshpass)..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends sshpass
          echo "âœ… sshpass installed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ’¾ Create and cleanup database backup
        run: |
          echo "::add-mask::$SSH_PASSWORD"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ’¾ Creating database backup and cleaning up old backups..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST "DB_NAME='$DB_NAME' DB_USER='$DB_USER' bash -s" << 'ENDSSH'
            echo "ğŸ” Checking PostgreSQL container..."
            if docker ps --format '{{.Names}}' | grep -q 'transaction-db'; then
              echo "âœ… PostgreSQL container is running"
              
              BACKUP_DIR="/tmp/backups"
              mkdir -p "$BACKUP_DIR"
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              BACKUP_FILE="$BACKUP_DIR/${DB_NAME}_${TIMESTAMP}.sql"
              
              echo "ğŸ’¾ Creating backup: $BACKUP_FILE"
              docker exec transaction-db pg_dump -U "$DB_USER" -d "$DB_NAME" > "$BACKUP_FILE" 2>&1 || echo "âš ï¸ Backup may have failed (OK for first deployment)"
              
              if [ -f "$BACKUP_FILE" ] && [ -s "$BACKUP_FILE" ]; then
                BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
                echo "âœ… Backup created: $BACKUP_SIZE"
              fi
              
              echo "ğŸ§¹ Cleaning up old backups (keeping last 5)..."
              BACKUP_COUNT=$(ls -1 "$BACKUP_DIR/${DB_NAME}"_*.sql 2>/dev/null | wc -l)
              if [ "$BACKUP_COUNT" -gt 5 ]; then
                cd "$BACKUP_DIR"
                ls -t "${DB_NAME}"_*.sql 2>/dev/null | tail -n +6 | xargs rm -f || true
                echo "âœ… Old backups removed"
              fi
            else
              echo "â„¹ï¸ PostgreSQL container not running (OK for first deployment)"
            fi
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ENDSSH

  prepare-deployment:
    name: ğŸ“¦ Prepare Deployment
    runs-on: ubuntu-latest
    needs: backup
    
    steps:
      - name: ğŸ’¾ Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: apt-${{ runner.os }}-sshpass
          restore-keys: |
            apt-${{ runner.os }}-

      - name: ğŸ“¥ Install SSH tools
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¥ Installing SSH tools (sshpass)..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends sshpass
          echo "âœ… sshpass installed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ“¥ Clone repository and prepare archive
        env:
          REPO_URL: https://github.com/${{ github.repository }}.git
        run: |
          echo "::add-mask::$SSH_PASSWORD"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¦ Preparing deployment (clone + archive)..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST << ENDSSH
            echo "ğŸ“¥ Cloning repository..."
            mkdir -p /tmp
            cd /tmp
            rm -rf transaction-processor-api
            git clone $REPO_URL transaction-processor-api
            cd transaction-processor-api
            
            echo "ğŸ“¦ Creating application archive..."
            tar -czf app.tar.gz \
              --exclude='node_modules' --exclude='dist' --exclude='build' \
              --exclude='test' --exclude='coverage' --exclude='*.spec.ts' \
              --exclude='.git' --exclude='docker' --exclude='*.md' \
              src/ package*.json tsconfig*.json nest-cli.json migrations/ \
              eslint.config.mjs .prettierrc 2>&1
            
            echo "âœ… Archive created: $(du -h app.tar.gz | cut -f1)"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ENDSSH

  build-and-deploy:
    name: ğŸš€ Build and Deploy
    runs-on: ubuntu-latest
    needs: prepare-deployment
    
    steps:
      - name: ğŸ’¾ Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: apt-${{ runner.os }}-sshpass
          restore-keys: |
            apt-${{ runner.os }}-

      - name: ğŸ“¥ Install SSH tools
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¥ Installing SSH tools (sshpass)..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends sshpass
          echo "âœ… sshpass installed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸš€ Stop, build and start containers
        run: |
          echo "::add-mask::$SSH_PASSWORD"
          echo "::add-mask::$DB_PASSWORD"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸš€ Building and deploying containers..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST "DB_NAME='$DB_NAME' DB_USER='$DB_USER' DB_PASSWORD='$DB_PASSWORD' bash -s" << 'ENDSSH'
            cd /tmp/transaction-processor-api/docker
            
            echo "ğŸ›‘ Stopping existing containers..."
            docker compose down -v || true
            docker container prune -f || true
            docker volume prune -f || true
            
            echo "ğŸ”¨ Building containers with cache optimization..."
            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1
            echo "ğŸ“¥ Pulling base images (using cache)..."
            docker compose pull || true
            echo "ğŸ”¨ Building containers (reusing cached layers)..."
            docker compose build --pull --progress=plain
            
            echo "ğŸš€ Starting containers..."
            docker compose up -d
            
            echo "â³ Waiting for services to initialize..."
            sleep 15
            
            cd /tmp/transaction-processor-api
            rm -f app.tar.gz || true
            
            echo "ğŸ“Š Container status:"
            docker compose ps
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ENDSSH

  wait-services:
    name: â³ Wait Services and Restore Backup
    runs-on: ubuntu-latest
    needs: build-and-deploy
    
    steps:
      - name: ğŸ’¾ Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: apt-${{ runner.os }}-sshpass
          restore-keys: |
            apt-${{ runner.os }}-

      - name: ğŸ“¥ Install SSH tools
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¥ Installing SSH tools (sshpass)..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends sshpass
          echo "âœ… sshpass installed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: â³ Wait for services and restore backup
        run: |
          echo "::add-mask::$SSH_PASSWORD"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â³ Waiting for services and restoring backup..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST "DB_NAME='$DB_NAME' DB_USER='$DB_USER' bash -s" << 'ENDSSH'
            echo "â³ Waiting for PostgreSQL..."
            timeout=60
            elapsed=0
            while [ $elapsed -lt $timeout ]; do
              if docker exec transaction-db pg_isready -U "$DB_USER" > /dev/null 2>&1; then
                echo "âœ… PostgreSQL is ready"
                break
              fi
              sleep 2
              elapsed=$((elapsed + 2))
            done
            
            echo "ğŸ“¥ Restoring backup if available..."
            BACKUP_DIR="/tmp/backups"
            LATEST_BACKUP=$(ls -t "$BACKUP_DIR/${DB_NAME}"_*.sql 2>/dev/null | head -1)
            if [ -n "$LATEST_BACKUP" ] && [ -f "$LATEST_BACKUP" ]; then
              docker exec -i transaction-db psql -U "$DB_USER" -d postgres -c "DROP DATABASE IF EXISTS $DB_NAME;" || true
              docker exec -i transaction-db psql -U "$DB_USER" -d postgres -c "CREATE DATABASE $DB_NAME;" || true
              cat "$LATEST_BACKUP" | docker exec -i transaction-db psql -U "$DB_USER" -d "$DB_NAME" || echo "âš ï¸ Backup restore failed (OK for first deployment)"
            fi
            
            echo "â³ Waiting for application..."
            elapsed=0
            while [ $elapsed -lt $timeout ]; do
              if docker ps --format '{{.Names}}' | grep -q 'transaction-api' && \
                 docker exec transaction-api node -e "console.log('OK')" > /dev/null 2>&1; then
                echo "âœ… Application is ready"
                break
              fi
              sleep 2
              elapsed=$((elapsed + 2))
            done
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ENDSSH

  finalize-deployment:
    name: ğŸ”„ Finalize Deployment
    runs-on: ubuntu-latest
    needs: wait-services
    
    steps:
      - name: ğŸ’¾ Cache apt packages
        uses: actions/cache@v4
        with:
          path: /var/cache/apt
          key: apt-${{ runner.os }}-sshpass
          restore-keys: |
            apt-${{ runner.os }}-

      - name: ğŸ“¥ Install SSH tools
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“¥ Installing SSH tools (sshpass)..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends sshpass
          echo "âœ… sshpass installed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ”„ Run migrations and verify status
        run: |
          echo "::add-mask::$SSH_PASSWORD"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”„ Finalizing deployment (migrations + verification)..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST << 'ENDSSH'
            echo "ğŸ”„ Running database migrations..."
            docker exec transaction-api npm run migrate || echo "âš ï¸ Migrations may have already been applied"
            
            echo "ğŸ“Š Deployment status:"
            cd /tmp/transaction-processor-api/docker
            docker compose ps
            echo ""
            echo "ğŸ“‹ Application logs (last 20 lines):"
            docker compose logs --tail=20 transaction-api || true
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ENDSSH

  verify:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: finalize-deployment
    
    steps:
      - name: ğŸ” Verify HTTP redirects to HTTPS
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Verifying HTTP redirects to HTTPS..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Test configuration:"
          echo "   Domain: $DOMAIN"
          echo "   Endpoint: /health"
          echo "   Expected: HTTP redirect (301 or 302) to HTTPS"
          echo ""
          echo "ğŸ”¨ Testing HTTP endpoint..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$DOMAIN/health || echo "000")
          echo "   HTTP Status Code: $HTTP_STATUS"
          echo ""
          
          if [ "$HTTP_STATUS" = "301" ] || [ "$HTTP_STATUS" = "302" ]; then
            echo "âœ… SUCCESS: HTTP correctly redirects to HTTPS"
          else
            echo "âš ï¸  WARNING: HTTP returned status $HTTP_STATUS (expected 301 or 302)"
            echo "   This may indicate Nginx is not configured for HTTPS redirect"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ğŸ”’ Verify HTTPS endpoint
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”’ Verifying HTTPS endpoint..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Test configuration:"
          echo "   Domain: $DOMAIN"
          echo "   Endpoint: /health"
          echo "   Protocol: HTTPS"
          echo "   Expected: HTTP 200 OK"
          echo ""
          echo "ğŸ”¨ Testing HTTPS endpoint..."
          HTTPS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://$DOMAIN/health || echo "000")
          RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" https://$DOMAIN/health || echo "0")
          echo "   HTTPS Status Code: $HTTPS_STATUS"
          echo "   Response Time: ${RESPONSE_TIME}s"
          echo ""
          
          if [ "$HTTPS_STATUS" = "200" ]; then
            echo "âœ… SUCCESS: Deployment successful! HTTPS is working."
          else
            echo "âŒ ERROR: HTTPS endpoint returned status $HTTPS_STATUS (expected 200)"
            echo "   Deployment verification failed"
            exit 1
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: âœ… Verify health endpoint response
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Verifying health endpoint response..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Test configuration:"
          echo "   Endpoint: https://$DOMAIN/health"
          echo "   Expected: JSON response with status: UP"
          echo ""
          echo "ğŸ”¨ Fetching health endpoint response..."
          RESPONSE=$(curl -s https://$DOMAIN/health)
          echo "   Response: $RESPONSE"
          echo ""
          
          if echo "$RESPONSE" | grep -q '"status":"UP"'; then
            echo "âœ… SUCCESS: Health endpoint is responding correctly"
            echo "   Application status: UP"
          else
            echo "âš ï¸  WARNING: Health endpoint response may be incorrect"
            echo "   Response does not contain expected status: UP"
          fi
          echo ""
          echo "ğŸ“Š Parsed health check details:"
          echo "$RESPONSE" | grep -o '"status":"[^"]*"' || echo "   Unable to parse status"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ‰ Deployment verification completed successfully!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
