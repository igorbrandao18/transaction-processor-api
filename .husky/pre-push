#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ðŸ” Running lint..."
npm run lint:check

echo "ðŸ”§ Starting test database containers..."
cd docker
docker compose --profile test up -d postgres-test redis-test
cd ..

echo "â³ Waiting for PostgreSQL to be ready..."
until docker exec transaction-db-test pg_isready -U postgres > /dev/null 2>&1; do
  echo "Waiting for PostgreSQL..."
  sleep 2
done

echo "ðŸ”„ Running migrations..."
NODE_ENV=test \
DB_HOST=localhost \
DB_PORT=5433 \
DB_USER=postgres \
DB_PASSWORD=postgres \
DB_NAME=transactions_db_test \
REDIS_HOST=localhost \
REDIS_PORT=6380 \
npm run migrate

echo "ðŸ§ª Running all tests..."
NODE_ENV=test \
DB_HOST=localhost \
DB_PORT=5433 \
DB_USER=postgres \
DB_PASSWORD=postgres \
DB_NAME=transactions_db_test \
REDIS_HOST=localhost \
REDIS_PORT=6380 \
npm run test:all

echo "ðŸ§¹ Stopping test containers..."
cd docker
docker compose --profile test stop postgres-test redis-test
docker compose --profile test rm -f postgres-test redis-test
cd ..

