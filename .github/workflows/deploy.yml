name: Deploy to Production

on:
  push:
    branches:
      - main

env:
  SSH_HOST: ${{ secrets.SSH_HOST }}
  SSH_USER: ${{ secrets.SSH_USER }}
  SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
  DB_NAME: ${{ secrets.DB_NAME || 'transactions_db' }}
  DB_USER: ${{ secrets.DB_USER || 'postgres' }}
  DB_PASSWORD: ${{ secrets.DB_PASSWORD || 'postgres' }}
  DOMAIN: ${{ secrets.DOMAIN }}

jobs:
  lint:
    name: Lint Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint:check

  test-unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        env:
          NODE_ENV: test
        run: npm run test:unit

  setup-test-database:
    name: ๐ฆ Setup Test Database
    runs-on: ubuntu-latest
    needs: test-unit
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: ๐ฅ Install PostgreSQL client tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing PostgreSQL client tools..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y postgresql-client
          echo "โ PostgreSQL client installed"
          psql --version

      - name: ๐ Check PostgreSQL service availability
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Checking PostgreSQL service availability..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Connection details:"
          echo "   Host: localhost"
          echo "   Port: 5432"
          echo "   User: postgres"
          echo "   Database: postgres (default)"
          echo ""
          echo "โณ Waiting for PostgreSQL to accept connections..."
          MAX_RETRIES=30
          RETRY_COUNT=0
          until pg_isready -h localhost -p 5432 -U postgres; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
              echo "โ PostgreSQL service did not become ready after $MAX_RETRIES attempts"
              exit 1
            fi
            echo "   Attempt $RETRY_COUNT/$MAX_RETRIES: PostgreSQL not ready yet, waiting 2 seconds..."
            sleep 2
          done
          echo "โ PostgreSQL service is ready and accepting connections"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ List existing databases
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Current databases before test database creation:"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          psql -h localhost -p 5432 -U postgres -c "\l" || true
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ Create test database
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
          TEST_DB_NAME: transactions_db_test
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Creating test database..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Database details:"
          echo "   Name: $TEST_DB_NAME"
          echo "   Owner: postgres"
          echo "   Encoding: UTF8 (default)"
          echo "   Purpose: Integration tests execution"
          echo ""
          echo "๐จ Executing CREATE DATABASE command..."
          if psql -h localhost -p 5432 -U postgres -c "CREATE DATABASE $TEST_DB_NAME;" 2>&1; then
            echo ""
            echo "โ SUCCESS: Test database '$TEST_DB_NAME' created successfully!"
          else
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 0 ]; then
              echo ""
              echo "โ๏ธ  WARNING: Database '$TEST_DB_NAME' may already exist (this is OK)"
            else
              echo ""
              echo "โ ERROR: Failed to create test database"
              exit $EXIT_CODE
            fi
          fi
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: โ Verify test database creation
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
          TEST_DB_NAME: transactions_db_test
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ Verifying test database exists..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          if psql -h localhost -p 5432 -U postgres -lqt | cut -d \| -f 1 | grep -qw "$TEST_DB_NAME"; then
            echo "โ VERIFIED: Test database '$TEST_DB_NAME' exists"
            echo ""
            echo "๐ Database information:"
            psql -h localhost -p 5432 -U postgres -c "\l" | grep -E "Name|$TEST_DB_NAME" || true
          else
            echo "โ ERROR: Test database '$TEST_DB_NAME' was not created!"
            exit 1
          fi
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Test database setup completed successfully!"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: setup-test-database
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install PostgreSQL client
        run: sudo apt-get update && sudo apt-get install -y postgresql-client

      - name: Wait for PostgreSQL service
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
        run: |
          echo "๐ Checking PostgreSQL service availability..."
          until pg_isready -h localhost -p 5432 -U postgres; do
            echo "โณ Waiting for PostgreSQL to be ready..."
            sleep 2
          done
          echo "โ PostgreSQL service is ready"

      - name: Verify test database exists
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
        run: |
          echo "๐ Verifying test database exists..."
          psql -h localhost -p 5432 -U postgres -lqt | cut -d \| -f 1 | grep -qw transactions_db_test && \
            echo "โ Test database 'transactions_db_test' exists" || \
            (echo "โ Test database not found!" && exit 1)

      - name: Run database migrations
        env:
          NODE_ENV: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_NAME: transactions_db_test
        run: |
          echo "๐ Running database migrations on test database..."
          npm run migrate
          echo "โ Migrations completed"

      - name: Run integration tests
        env:
          NODE_ENV: test
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_NAME: transactions_db_test
          REDIS_HOST: localhost
          REDIS_PORT: 6379
        run: |
          echo "๐งช Running integration tests against test database..."
          npm run test:integration

  cleanup-test-database:
    name: ๐๏ธ  Cleanup Test Database
    runs-on: ubuntu-latest
    needs: [setup-test-database, test-integration]
    if: always()
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: ๐ฅ Install PostgreSQL client tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing PostgreSQL client tools for cleanup..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y postgresql-client
          echo "โ PostgreSQL client installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ Check PostgreSQL service availability
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Checking PostgreSQL service availability..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          MAX_RETRIES=30
          RETRY_COUNT=0
          until pg_isready -h localhost -p 5432 -U postgres; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
              echo "โ PostgreSQL service did not become ready"
              exit 1
            fi
            echo "   Attempt $RETRY_COUNT/$MAX_RETRIES: Waiting for PostgreSQL..."
            sleep 2
          done
          echo "โ PostgreSQL service is ready"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ List databases before cleanup
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
          TEST_DB_NAME: transactions_db_test
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Current databases before cleanup:"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          psql -h localhost -p 5432 -U postgres -c "\l" || true
          echo ""
          if psql -h localhost -p 5432 -U postgres -lqt | cut -d \| -f 1 | grep -qw "$TEST_DB_NAME"; then
            echo "โ Test database '$TEST_DB_NAME' found - will be removed"
          else
            echo "โ๏ธ  Test database '$TEST_DB_NAME' not found - may have been already removed"
          fi
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐๏ธ  Drop test database
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
          TEST_DB_NAME: transactions_db_test
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐๏ธ  Cleaning up test database..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Cleanup details:"
          echo "   Database to remove: $TEST_DB_NAME"
          echo "   Command: DROP DATABASE IF EXISTS $TEST_DB_NAME"
          echo "   Purpose: Free up resources after test execution"
          echo ""
          echo "๐จ Executing DROP DATABASE command..."
          if psql -h localhost -p 5432 -U postgres -c "DROP DATABASE IF EXISTS $TEST_DB_NAME;" 2>&1; then
            echo ""
            echo "โ SUCCESS: Test database '$TEST_DB_NAME' destroyed successfully!"
          else
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 0 ]; then
              echo ""
              echo "โ๏ธ  WARNING: Database '$TEST_DB_NAME' may not exist (this is OK)"
            else
              echo ""
              echo "โ ERROR: Failed to drop test database (exit code: $EXIT_CODE)"
              echo "โ๏ธ  Continuing cleanup process..."
            fi
          fi
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: โ Verify test database removal
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
          TEST_DB_NAME: transactions_db_test
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ Verifying test database has been removed..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          if psql -h localhost -p 5432 -U postgres -lqt | cut -d \| -f 1 | grep -qw "$TEST_DB_NAME"; then
            echo "โ๏ธ  WARNING: Test database '$TEST_DB_NAME' still exists"
            echo "๐ Current database list:"
            psql -h localhost -p 5432 -U postgres -c "\l" || true
          else
            echo "โ VERIFIED: Test database '$TEST_DB_NAME' has been successfully removed"
          fi
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ Show remaining databases
        env:
          PGHOST: localhost
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: postgres
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Remaining databases after cleanup:"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          psql -h localhost -p 5432 -U postgres -c "\l" || true
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Test database cleanup completed!"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

  setup:
    name: ๐ Setup and Verify SSH Connection
    runs-on: ubuntu-latest
    needs: cleanup-test-database
    
    steps:
      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y sshpass
          echo "โ sshpass installed successfully"
          sshpass -V || true
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ Test SSH connection
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Testing SSH connection to deployment server..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Connection details:"
          echo "   Host: $SSH_HOST"
          echo "   User: $SSH_USER"
          echo "   Method: Password authentication"
          echo ""
          echo "๐จ Attempting SSH connection..."
          if sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout=10 \
            $SSH_USER@$SSH_HOST "echo 'โ SSH connection successful' && hostname && uname -a"; then
            echo ""
            echo "โ SUCCESS: SSH connection established successfully!"
          else
            echo ""
            echo "โ ERROR: Failed to establish SSH connection"
            exit 1
          fi
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

  check-postgres-container:
    name: ๐ Check PostgreSQL Container
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y sshpass
          echo "โ sshpass installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ Check PostgreSQL container status
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Checking PostgreSQL container status on server..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST "bash -s" << 'ENDSSH'
            echo "๐ Checking Docker containers..."
            echo ""
            echo "๐ Looking for PostgreSQL container 'transaction-db'..."
            if docker ps --format '{{.Names}}' | grep -q 'transaction-db'; then
              echo "โ PostgreSQL container 'transaction-db' is RUNNING"
              echo ""
              echo "๐ Container details:"
              docker ps --filter "name=transaction-db" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
              echo ""
              echo "๐ Container health:"
              docker inspect transaction-db --format='{{.State.Status}}' 2>/dev/null || echo "Unable to inspect"
            else
              echo "โ๏ธ  PostgreSQL container 'transaction-db' is NOT RUNNING"
              echo ""
              echo "๐ All running containers:"
              docker ps --format "table {{.Names}}\t{{.Status}}" || echo "No containers running"
              echo ""
              echo "โน๏ธ  This is OK for first deployment - backup will be skipped"
            fi
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH

  create-backup:
    name: ๐พ Create Database Backup
    runs-on: ubuntu-latest
    needs: check-postgres-container
    
    steps:
      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y sshpass
          echo "โ sshpass installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐พ Create database backup
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐พ Creating database backup..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST "DB_NAME='$DB_NAME' DB_USER='$DB_USER' bash -s" << 'ENDSSH'
            echo "๐ Backup configuration:"
            echo "   Database: $DB_NAME"
            echo "   User: $DB_USER"
            echo "   Container: transaction-db"
            echo ""
            echo "๐ Checking if PostgreSQL container is running..."
            if docker ps --format '{{.Names}}' | grep -q 'transaction-db'; then
              echo "โ PostgreSQL container is running"
              echo ""
              
              BACKUP_DIR="/tmp/backups"
              mkdir -p "$BACKUP_DIR"
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              BACKUP_FILE="$BACKUP_DIR/${DB_NAME}_${TIMESTAMP}.sql"
              
              echo "๐ฆ Preparing backup directory..."
              echo "   Directory: $BACKUP_DIR"
              echo "   Backup file: $BACKUP_FILE"
              echo ""
              
              echo "๐จ Executing pg_dump command..."
              echo "   Command: docker exec transaction-db pg_dump -U $DB_USER -d $DB_NAME"
              if docker exec transaction-db pg_dump -U "$DB_USER" -d "$DB_NAME" > "$BACKUP_FILE" 2>&1; then
                echo "โ pg_dump command executed successfully"
              else
                EXIT_CODE=$?
                echo "โ๏ธ  pg_dump exited with code: $EXIT_CODE"
                echo "โ๏ธ  This may be OK if database doesn't exist yet (first deployment)"
              fi
              
              echo ""
              echo "๐ Verifying backup file..."
              if [ -f "$BACKUP_FILE" ] && [ -s "$BACKUP_FILE" ]; then
                BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
                BACKUP_LINES=$(wc -l < "$BACKUP_FILE")
                echo "โ Backup file created successfully!"
                echo "   File: $BACKUP_FILE"
                echo "   Size: $BACKUP_SIZE"
                echo "   Lines: $BACKUP_LINES"
                echo ""
                echo "๐ Backup file details:"
                ls -lh "$BACKUP_FILE"
              else
                echo "โ๏ธ  Backup file is empty or does not exist"
                echo "   This is OK for first deployment (no existing data)"
              fi
            else
              echo "โน๏ธ  PostgreSQL container is not running"
              echo "   Skipping backup (this is OK for first deployment)"
            fi
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH

  cleanup-old-backups:
    name: ๐งน Cleanup Old Backups
    runs-on: ubuntu-latest
    needs: create-backup
    
    steps:
      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y sshpass
          echo "โ sshpass installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐งน Cleanup old backup files
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐งน Cleaning up old backup files..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST "DB_NAME='$DB_NAME' bash -s" << 'ENDSSH'
            BACKUP_DIR="/tmp/backups"
            echo "๐ Cleanup configuration:"
            echo "   Backup directory: $BACKUP_DIR"
            echo "   Keep last: 5 backups"
            echo "   Database pattern: ${DB_NAME}_*.sql"
            echo ""
            
            if [ -d "$BACKUP_DIR" ]; then
              echo "๐ Current backups before cleanup:"
              ls -lht "$BACKUP_DIR/${DB_NAME}"_*.sql 2>/dev/null | head -10 || echo "   No backups found"
              echo ""
              
              BACKUP_COUNT=$(ls -1 "$BACKUP_DIR/${DB_NAME}"_*.sql 2>/dev/null | wc -l)
              echo "๐ Total backups found: $BACKUP_COUNT"
              
              if [ "$BACKUP_COUNT" -gt 5 ]; then
                REMOVE_COUNT=$((BACKUP_COUNT - 5))
                echo "๐งน Removing $REMOVE_COUNT old backup(s)..."
                cd "$BACKUP_DIR"
                ls -t "${DB_NAME}"_*.sql 2>/dev/null | tail -n +6 | while read -r old_backup; do
                  echo "   Removing: $old_backup"
                  rm -f "$old_backup"
                done
                echo "โ Old backups removed"
              else
                echo "โ No cleanup needed (only $BACKUP_COUNT backup(s) found)"
              fi
              
              echo ""
              echo "๐ Remaining backups after cleanup:"
              ls -lht "$BACKUP_DIR/${DB_NAME}"_*.sql 2>/dev/null | head -5 || echo "   No backups remaining"
            else
              echo "โ๏ธ  Backup directory does not exist: $BACKUP_DIR"
              echo "   This is OK for first deployment"
            fi
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH

  clone-repository:
    name: ๐ฅ Clone Repository
    runs-on: ubuntu-latest
    needs: cleanup-old-backups
    
    steps:
      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y sshpass
          echo "โ sshpass installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ฅ Clone repository from GitHub
        env:
          REPO_URL: https://github.com/${{ github.repository }}.git
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Cloning repository to deployment server..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST << ENDSSH
            echo "๐ Clone configuration:"
            echo "   Repository: $REPO_URL"
            echo "   Target directory: /tmp/transaction-processor-api"
            echo "   Branch: main (default)"
            echo ""
            echo "๐๏ธ  Removing existing repository directory (if exists)..."
            mkdir -p /tmp
            cd /tmp
            if [ -d "transaction-processor-api" ]; then
              echo "   Found existing directory, removing..."
              rm -rf transaction-processor-api
              echo "   โ Existing directory removed"
            else
              echo "   โ No existing directory found (first deployment)"
            fi
            echo ""
            echo "๐ฅ Cloning repository..."
            if git clone $REPO_URL transaction-processor-api; then
              echo "โ Repository cloned successfully"
              echo ""
              cd transaction-processor-api
              echo "๐ Repository information:"
              echo "   Current commit: $(git rev-parse HEAD)"
              echo "   Commit message: $(git log -1 --pretty=%B)"
              echo "   Branch: $(git branch --show-current)"
              echo ""
              echo "๐ Repository structure:"
              ls -la
            else
              echo "โ ERROR: Failed to clone repository"
              exit 1
            fi
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH

  prepare-archive:
    name: ๐ฆ Prepare Application Archive
    runs-on: ubuntu-latest
    needs: clone-repository
    
    steps:
      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y sshpass
          echo "โ sshpass installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ฆ Create application archive
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฆ Creating application archive for Docker build..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST << 'ENDSSH'
            cd /tmp/transaction-processor-api
            
            echo "๐ Archive configuration:"
            echo "   Format: tar.gz (compressed)"
            echo "   Target file: app.tar.gz"
            echo "   Purpose: Optimize Docker build context"
            echo ""
            echo "๐ Files to include:"
            echo "   โ src/ (source code)"
            echo "   โ package.json, package-lock.json"
            echo "   โ tsconfig.json, nest-cli.json, tsconfig.build.json"
            echo "   โ migrations/ (database migrations)"
            echo "   โ eslint.config.mjs, .prettierrc"
            echo ""
            echo "๐ซ Files to exclude:"
            echo "   โ node_modules/, dist/, build/"
            echo "   โ test/, coverage/, *.spec.ts, *.test.ts"
            echo "   โ .git/, .env*, logs/, *.log"
            echo "   โ docker/ (Docker files)"
            echo ""
            echo "๐จ Creating archive..."
            if tar -czf app.tar.gz \
              --exclude='node_modules' \
              --exclude='dist' \
              --exclude='build' \
              --exclude='*.tsbuildinfo' \
              --exclude='test' \
              --exclude='coverage' \
              --exclude='*.spec.ts' \
              --exclude='*.test.ts' \
              --exclude='*.e2e-spec.ts' \
              --exclude='README.md' \
              --exclude='docs' \
              --exclude='*.md' \
              --exclude='.git' \
              --exclude='.gitignore' \
              --exclude='.gitattributes' \
              --exclude='.vscode' \
              --exclude='.idea' \
              --exclude='*.swp' \
              --exclude='*.swo' \
              --exclude='*~' \
              --exclude='.env' \
              --exclude='.env.local' \
              --exclude='.env.*.local' \
              --exclude='.DS_Store' \
              --exclude='Thumbs.db' \
              --exclude='logs' \
              --exclude='*.log' \
              --exclude='.eslintcache' \
              --exclude='docker' \
              --exclude='.dockerignore' \
              --exclude='docker-compose.yml' \
              src/ \
              package.json \
              package-lock.json \
              tsconfig.json \
              nest-cli.json \
              migrations/ \
              eslint.config.mjs \
              .prettierrc \
              tsconfig.build.json 2>&1; then
              echo ""
              echo "โ Archive created successfully!"
              echo ""
              echo "๐ Archive details:"
              ls -lh app.tar.gz
              ARCHIVE_SIZE=$(du -h app.tar.gz | cut -f1)
              echo "   Size: $ARCHIVE_SIZE"
            else
              EXIT_CODE=$?
              echo ""
              echo "โ ERROR: Failed to create archive (exit code: $EXIT_CODE)"
              exit $EXIT_CODE
            fi
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH

  stop-containers:
    name: ๐ Stop Existing Containers
    runs-on: ubuntu-latest
    needs: prepare-archive
    
    steps:
      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y sshpass
          echo "โ sshpass installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ Stop containers and clean up
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Stopping existing containers and cleaning up..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST << 'ENDSSH'
            cd /tmp/transaction-processor-api/docker
            
            echo "๐ Current container status before cleanup:"
            docker compose ps 2>/dev/null || echo "   No containers running"
            echo ""
            
            echo "๐งน Cleaning up unused containers (keeping build cache)..."
            docker container prune -f
            echo "โ Unused containers removed"
            echo ""
            
            echo "๐งน Cleaning up unused volumes (keeping build cache)..."
            docker volume prune -f
            echo "โ Unused volumes removed"
            echo ""
            
            echo "๐ Stopping existing containers and removing volumes..."
            if docker compose down -v 2>&1; then
              echo "โ Containers stopped and volumes removed successfully"
            else
              echo "โ๏ธ  No existing containers to stop (this is OK for first deployment)"
            fi
            echo ""
            
            echo "๐ Container status after cleanup:"
            docker compose ps 2>/dev/null || echo "   No containers running"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH

  build-containers:
    name: ๐จ Build Docker Containers
    runs-on: ubuntu-latest
    needs: stop-containers
    
    steps:
      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y sshpass
          echo "โ sshpass installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐จ Build Docker containers
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐จ Building Docker containers..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST << 'ENDSSH'
            cd /tmp/transaction-processor-api/docker
            
            echo "โ๏ธ  Configuring Docker BuildKit for optimized caching..."
            export DOCKER_BUILDKIT=1
            export COMPOSE_DOCKER_CLI_BUILD=1
            echo "โ BuildKit enabled"
            echo ""
            
            echo "๐ฅ Pulling base images (using cache)..."
            if docker compose pull 2>&1; then
              echo "โ Base images pulled successfully"
            else
              echo "โ๏ธ  Some images may not exist yet (this is OK)"
            fi
            echo ""
            
            echo "๐จ Building containers with cache optimization..."
            echo "   Strategy: Only rebuild changed layers"
            echo "   Cache: Using Docker BuildKit cache"
            echo "   Pull: Always pull latest base images"
            echo ""
            if docker compose build --pull 2>&1; then
              echo "โ Containers built successfully!"
            else
              EXIT_CODE=$?
              echo "โ ERROR: Failed to build containers (exit code: $EXIT_CODE)"
              exit $EXIT_CODE
            fi
            echo ""
            
            echo "๐งน Cleaning up archive after build..."
            cd /tmp/transaction-processor-api
            rm -f app.tar.gz || true
            echo "โ Archive cleaned up"
            echo ""
            
            echo "๐ Built images:"
            docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | grep -E "REPOSITORY|transaction" || true
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH

  start-containers:
    name: ๐ Start Docker Containers
    runs-on: ubuntu-latest
    needs: build-containers
    
    steps:
      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y sshpass
          echo "โ sshpass installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ Start containers
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Starting Docker containers..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST << 'ENDSSH'
            cd /tmp/transaction-processor-api/docker
            
            echo "๐ Starting services:"
            echo "   - PostgreSQL database (transaction-db)"
            echo "   - Redis cache (transaction-redis)"
            echo "   - Application API (transaction-api)"
            echo ""
            
            echo "๐จ Executing docker compose up -d..."
            if docker compose up -d 2>&1; then
              echo "โ Containers started successfully"
            else
              EXIT_CODE=$?
              echo "โ ERROR: Failed to start containers (exit code: $EXIT_CODE)"
              exit $EXIT_CODE
            fi
            echo ""
            
            echo "โณ Waiting 15 seconds for services to initialize..."
            sleep 15
            echo "โ Initialization wait completed"
            echo ""
            
            echo "๐ Container status after startup:"
            docker compose ps
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH

  wait-postgres:
    name: โณ Wait for PostgreSQL
    runs-on: ubuntu-latest
    needs: start-containers
    
    steps:
      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y sshpass
          echo "โ sshpass installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: โณ Wait for PostgreSQL to be ready
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โณ Waiting for PostgreSQL to be ready..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST "DB_USER='$DB_USER' bash -s" << 'ENDSSH'
            echo "๐ PostgreSQL readiness check:"
            echo "   Container: transaction-db"
            echo "   User: $DB_USER"
            echo "   Command: pg_isready"
            echo "   Timeout: 60 seconds"
            echo ""
            
            timeout=60
            elapsed=0
            MAX_RETRIES=$((timeout / 2))
            RETRY_COUNT=0
            
            while [ $elapsed -lt $timeout ]; do
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if docker exec transaction-db pg_isready -U "$DB_USER" > /dev/null 2>&1; then
                echo "โ PostgreSQL is ready and accepting connections!"
                echo "   Elapsed time: ${elapsed}s"
                echo "   Attempts: $RETRY_COUNT/$MAX_RETRIES"
                break
              fi
              echo "   Attempt $RETRY_COUNT/$MAX_RETRIES: PostgreSQL not ready yet... (${elapsed}s/${timeout}s)"
              sleep 2
              elapsed=$((elapsed + 2))
            done
            
            if [ $elapsed -ge $timeout ]; then
              echo "โ ERROR: PostgreSQL did not become ready within ${timeout} seconds"
              echo "๐ Container logs:"
              docker logs transaction-db --tail 20 || true
              exit 1
            fi
            
            echo ""
            echo "๐ PostgreSQL connection test:"
            docker exec transaction-db psql -U "$DB_USER" -d postgres -c "SELECT version();" | head -3 || true
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH

  restore-backup:
    name: ๐ฅ Restore Database Backup
    runs-on: ubuntu-latest
    needs: wait-postgres
    
    steps:
      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y sshpass
          echo "โ sshpass installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ฅ Restore database from backup
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Restoring database backup if available..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST "DB_NAME='$DB_NAME' DB_USER='$DB_USER' bash -s" << 'ENDSSH'
            BACKUP_DIR="/tmp/backups"
            echo "๐ Restore configuration:"
            echo "   Backup directory: $BACKUP_DIR"
            echo "   Database: $DB_NAME"
            echo "   User: $DB_USER"
            echo ""
            
            echo "๐ Looking for latest backup..."
            LATEST_BACKUP=$(ls -t "$BACKUP_DIR/${DB_NAME}"_*.sql 2>/dev/null | head -1)
            
            if [ -n "$LATEST_BACKUP" ] && [ -f "$LATEST_BACKUP" ]; then
              BACKUP_SIZE=$(du -h "$LATEST_BACKUP" | cut -f1)
              BACKUP_LINES=$(wc -l < "$LATEST_BACKUP")
              echo "โ Found backup: $LATEST_BACKUP"
              echo "   Size: $BACKUP_SIZE"
              echo "   Lines: $BACKUP_LINES"
              echo ""
              
              echo "๐ Restoring database from backup..."
              echo "   Step 1: Dropping existing database (if exists)..."
              docker exec -i transaction-db psql -U "$DB_USER" -d postgres -c "DROP DATABASE IF EXISTS $DB_NAME;" 2>&1 || true
              echo "   โ Database dropped"
              echo ""
              
              echo "   Step 2: Creating fresh database..."
              docker exec -i transaction-db psql -U "$DB_USER" -d postgres -c "CREATE DATABASE $DB_NAME;" 2>&1 || true
              echo "   โ Database created"
              echo ""
              
              echo "   Step 3: Restoring data from backup..."
              if cat "$LATEST_BACKUP" | docker exec -i transaction-db psql -U "$DB_USER" -d "$DB_NAME" 2>&1; then
                echo "   โ Database restored successfully from backup!"
                echo ""
                echo "๐ Verifying restored database..."
                docker exec transaction-db psql -U "$DB_USER" -d "$DB_NAME" -c "\dt" 2>&1 | head -10 || true
              else
                EXIT_CODE=$?
                echo "   โ๏ธ  WARNING: Failed to restore backup (exit code: $EXIT_CODE)"
                echo "   Database will be empty - migrations will create schema"
              fi
            else
              echo "โน๏ธ  No backup found in $BACKUP_DIR"
              echo "   This is OK for first deployment"
              echo "   Database will be created fresh by migrations"
            fi
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH

  wait-application:
    name: โณ Wait for Application
    runs-on: ubuntu-latest
    needs: restore-backup
    
    steps:
      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y sshpass
          echo "โ sshpass installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: โณ Wait for application container to be ready
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โณ Waiting for application container to be ready..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST << 'ENDSSH'
            echo "๐ Application readiness check:"
            echo "   Container: transaction-api"
            echo "   Check: Node.js process running"
            echo "   Timeout: 60 seconds"
            echo ""
            
            timeout=60
            elapsed=0
            MAX_RETRIES=$((timeout / 2))
            RETRY_COUNT=0
            
            while [ $elapsed -lt $timeout ]; do
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if docker ps --format '{{.Names}}' | grep -q 'transaction-api' && \
                 docker exec transaction-api node -e "console.log('OK')" > /dev/null 2>&1; then
                echo "โ Application container is ready!"
                echo "   Elapsed time: ${elapsed}s"
                echo "   Attempts: $RETRY_COUNT/$MAX_RETRIES"
                break
              fi
              echo "   Attempt $RETRY_COUNT/$MAX_RETRIES: Application not ready yet... (${elapsed}s/${timeout}s)"
              sleep 2
              elapsed=$((elapsed + 2))
            done
            
            if [ $elapsed -ge $timeout ]; then
              echo "โ ERROR: Application did not become ready within ${timeout} seconds"
              echo "๐ Container logs:"
              docker logs transaction-api --tail 30 || true
              exit 1
            fi
            
            echo ""
            echo "๐ Application container status:"
            docker ps --filter "name=transaction-api" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH

  run-migrations:
    name: ๐ Run Database Migrations
    runs-on: ubuntu-latest
    needs: wait-application
    
    steps:
      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y sshpass
          echo "โ sshpass installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ Run database migrations
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Running database migrations..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST << 'ENDSSH'
            echo "๐ Migration configuration:"
            echo "   Container: transaction-api"
            echo "   Command: npm run migrate"
            echo "   Database: transactions_db (from environment)"
            echo ""
            
            echo "๐จ Executing migrations..."
            if docker exec transaction-api npm run migrate 2>&1; then
              echo "โ Migrations executed successfully!"
              echo ""
              echo "๐ Verifying migration results..."
              docker exec transaction-db psql -U postgres -d transactions_db -c "\dt" 2>&1 | head -10 || true
            else
              EXIT_CODE=$?
              echo "โ๏ธ  WARNING: Migration command exited with code: $EXIT_CODE"
              echo "   This may be OK if migrations were already applied"
              echo "   Checking database tables..."
              docker exec transaction-db psql -U postgres -d transactions_db -c "\dt" 2>&1 || true
            fi
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH

  verify-deployment-status:
    name: ๐ Verify Deployment Status
    runs-on: ubuntu-latest
    needs: run-migrations
    
    steps:
      - name: ๐ฅ Install SSH tools
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ฅ Installing SSH tools (sshpass)..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sudo apt-get update -qq
          sudo apt-get install -y sshpass
          echo "โ sshpass installed"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ Show deployment status
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Verifying deployment status..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          sshpass -p "$SSH_PASSWORD" ssh \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            $SSH_USER@$SSH_HOST << 'ENDSSH'
            cd /tmp/transaction-processor-api/docker
            
            echo "๐ Container status:"
            docker compose ps
            echo ""
            
            echo "๐ Container health:"
            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "NAMES|transaction" || true
            echo ""
            
            echo "๐ Application logs (last 30 lines):"
            docker compose logs --tail=30 transaction-api || docker logs transaction-api --tail 30 || true
            echo ""
            
            echo "๐ Database container logs (last 10 lines):"
            docker compose logs --tail=10 transaction-db || docker logs transaction-db --tail 10 || true
            echo ""
            
            echo "๐ Redis container logs (last 10 lines):"
            docker compose logs --tail=10 transaction-redis || docker logs transaction-redis --tail 10 || true
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ Deployment verification completed!"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH

  verify:
    name: โ Verify Deployment
    runs-on: ubuntu-latest
    needs: verify-deployment-status
    
    steps:
      - name: ๐ Verify HTTP redirects to HTTPS
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Verifying HTTP redirects to HTTPS..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Test configuration:"
          echo "   Domain: $DOMAIN"
          echo "   Endpoint: /health"
          echo "   Expected: HTTP redirect (301 or 302) to HTTPS"
          echo ""
          echo "๐จ Testing HTTP endpoint..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://$DOMAIN/health)
          echo "   HTTP Status Code: $HTTP_STATUS"
          echo ""
          
          if [ "$HTTP_STATUS" = "301" ] || [ "$HTTP_STATUS" = "302" ]; then
            echo "โ SUCCESS: HTTP correctly redirects to HTTPS"
          else
            echo "โ๏ธ  WARNING: HTTP returned status $HTTP_STATUS (expected 301 or 302)"
            echo "   This may indicate Nginx is not configured for HTTPS redirect"
          fi
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ Verify HTTPS endpoint
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Verifying HTTPS endpoint..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Test configuration:"
          echo "   Domain: $DOMAIN"
          echo "   Endpoint: /health"
          echo "   Protocol: HTTPS"
          echo "   Expected: HTTP 200 OK"
          echo ""
          echo "๐จ Testing HTTPS endpoint..."
          HTTPS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://$DOMAIN/health)
          RESPONSE_TIME=$(curl -s -o /dev/null -w "%{time_total}" https://$DOMAIN/health)
          echo "   HTTPS Status Code: $HTTPS_STATUS"
          echo "   Response Time: ${RESPONSE_TIME}s"
          echo ""
          
          if [ "$HTTPS_STATUS" = "200" ]; then
            echo "โ SUCCESS: Deployment successful! HTTPS is working."
          else
            echo "โ ERROR: HTTPS endpoint returned status $HTTPS_STATUS (expected 200)"
            echo "   Deployment verification failed"
            exit 1
          fi
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: โ Verify health endpoint response
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ Verifying health endpoint response..."
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Test configuration:"
          echo "   Endpoint: https://$DOMAIN/health"
          echo "   Expected: JSON response with status: UP"
          echo ""
          echo "๐จ Fetching health endpoint response..."
          RESPONSE=$(curl -s https://$DOMAIN/health)
          echo "   Response: $RESPONSE"
          echo ""
          
          if echo "$RESPONSE" | grep -q '"status":"UP"'; then
            echo "โ SUCCESS: Health endpoint is responding correctly"
            echo "   Application status: UP"
          else
            echo "โ๏ธ  WARNING: Health endpoint response may be incorrect"
            echo "   Response does not contain expected status: UP"
          fi
          echo ""
          echo "๐ Parsed health check details:"
          echo "$RESPONSE" | grep -o '"status":"[^"]*"' || echo "   Unable to parse status"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ Deployment verification completed successfully!"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
